{% import 'macros/form.html' as form %}

{% block form %}
<form id="user-edit-form" method="post" action="{{ action }}" enctype="multipart/form-data" class="needs-validation" novalidate>
  {{ h.csrf_input() }}

  {# ---- Error Handling ---- #}
  {% block form_errors %}
    {% if error_summary %}
      <div class="shadow-sm rounded-3 alert alert-danger">
        {{ form.errors(error_summary) }}
      </div>
    {% endif %}
  {% endblock %}

  {# ---- User Details ---- #}
  {% block core_fields %}
  <div class="shadow-sm mb-4 border-0 card">
    <div class="bg-primary rounded-top text-white card-header" style="background-color: #00A0D1 !important;">
      <h5 class="mb-0"><i class="bi bi-person-circle"></i> {{ _('Profile Information') }}</h5>
    </div>
    <div class="card-body">

      <div class="mb-3">
        {% if g.userobj.sysadmin %}
          {{ form.input('name', label=_('Username'), id='field-username', value=data.name, error=errors.name, classes=['form-control'], is_required=true) }}
        {% else %}
          {{ form.input('name', label=_('Username'), id='field-username', value=data.name, error=errors.name, classes=['form-control'], attrs={'readonly': 'readonly'}) }}
        {% endif %}
      </div>

      <div class="mb-3">
        {{ form.input('fullname', label=_('Full Name'), id='field-fullname', value=data.fullname, error=errors.fullname, placeholder=_('eg. Joe Bloggs'), classes=['form-control']) }}
      </div>

      <div class="mb-3">
        {{ form.input('email', label=_('Email'), id='field-email', type='email', value=data.email, error=errors.email, placeholder=_('eg. joe@example.com'), classes=['form-control'], is_required=true) }}
      </div>

      <div class="mb-3">
        {{ form.markdown('about', label=_('About'), id='field-about', value=data.about, error=errors.about, placeholder=_('A little information about yourself')) }}
      </div>

      <div class="mb-3">
        {% set is_upload = data.image_url and not data.image_url.startswith('http') %}
        {% set is_url = data.image_url and data.image_url.startswith('http') %}
        {{ form.image_upload(data, errors, is_upload_enabled=h.uploads_enabled(), is_url=is_url, is_upload=is_upload, upload_label=_('Profile picture'), url_label=_('Profile picture URL') ) }}
      </div>
    </div>
  </div>
  {% endblock %}

  {# ---- Password Section ---- #}
  <div class="shadow-sm mb-4 border-0 card">
    <div class="bg-secondary rounded-top text-white card-header" style="background-color: #00A0D1 !important;">
      <h5 class="mb-0"><i class="bi bi-lock"></i> {{ _('Password Settings') }}</h5>
    </div>
    <div class="card-body">
      {% if is_sysadmin and current_user.name != data.name %}
        {{ form.input('password1', type='password', label=_('New Password'), id='field-password', value=data.password1, error=errors.password1, classes=['form-control']) }}
        {{ form.input('password2', type='password', label=_('Confirm Password'), id='field-password-confirm', value=data.password2, error=errors.password2, classes=['form-control']) }}
      {% else %}
        {{ form.input('old_password', type='password', label=_('Old Password'), id='field-password-old', value=data.oldpassword, error=errors.oldpassword, classes=['form-control']) }}
        {{ form.input('password1', type='password', label=_('New Password'), id='field-password', value=data.password1, error=errors.password1, classes=['form-control']) }}
        {{ form.input('password2', type='password', label=_('Confirm Password'), id='field-password-confirm', value=data.password2, error=errors.password2, classes=['form-control']) }}
      {% endif %}
    </div>
  </div>

  {# ---- Submit Buttons ---- #}
  <div class="d-flex align-items-center justify-content-between">
    {% if h.check_access('user_delete', {'id': data.id}) and data.state != 'deleted' %}
      <a href="{{ h.url_for('user_delete', id=data.id) }}" 
         class="btn-outline-danger btn" 
         data-module="confirm-action" 
         data-module-content="{{ _('Are you sure you want to delete this User?') }}">
        <i class="fa fa-trash"></i> {{ _('Delete') }}
      </a>
    {% endif %}

    <button type="submit" name="save" class="shadow-sm btn btn-primary" style="background-color: #00A0D1 !important; ">
      <i class="fa fa-save"></i> {{ _('Reactivate Profile') if data.state == 'deleted' else _('Update Profile') }}
    </button>
  </div>
</form>
{% endblock %}
